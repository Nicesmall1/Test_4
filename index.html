<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Сделки «Идеи от Гуру»</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#FFFFFF;
  --card:#FFFFFF;
  --text:#000000;
  --muted:#666666;
  --accent:#EF3124;
  --border:#C9CACD;
  --blue:#0047FF;
}
*{box-sizing:border-box; margin:0; padding:0}
body{
  margin:0;
  padding:19.2px;
  background:var(--bg);
  color:var(--text);
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:400;
  font-size:12.8px;
  line-height:1;
}
.only-mobile { display: none; }
.desktop-only { display: inline; }
@media (max-width: 800px) {
  .only-mobile { display: inline-block; }
  .desktop-only { display: none; }
}
@media (max-width: 350px) {
  body { padding: 10px; font-size: 16px; -webkit-text-size-adjust: 100%; }
  h1 { font-size: 28px; line-height: 1.2; margin: 0 0 20px; text-align: center; }
  .container { padding: 0 10px; width: 100%; max-width: 100%; }
  .toolbar { gap: 12px; flex-direction: column; align-items: stretch; margin: 20px 0 15px; }
  .search { min-width: 100%; order: 1; }
  input[type="search"] { padding: 12px 16px; font-size: 16px; }
  .kpis { order: 2; justify-content: space-around; gap: 8px; flex-wrap: wrap; }
  .kpis .chip { font-size: 14px; padding: 8px 12px; flex: 1; min-width: 100px; text-align: center; }
  .filters { order: 3; justify-content: center; flex-wrap: wrap; gap: 6px; }
  button.filter { font-size: 12px; padding: 10px 12px; flex: 1; min-width: 80px; }
  .table-wrap { margin-bottom: 20px; max-height: calc(100vh - 250px); overflow: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; width: 100%; }
  table { width: 100%; min-width: 100%; }
  thead th, tbody td { padding: 10px 8px; font-size: 12px; }
  .badge, .status { font-size: 11px; padding: 5px 8px; white-space: nowrap; }
  .footer { font-size: 12px; margin-top: 15px; }
}

@media (max-width: 350px) {
  body { overflow-x: hidden; width: 100%; }
  .rwd-table, .rwd-table tbody, .rwd-table tr, .rwd-table td { box-sizing: border-box; }
  tbody td { word-break: break-word; max-width: 120px; overflow: hidden; text-overflow: ellipsis; }
}

.container{ max-width:1400px; margin:auto; padding:0 19.2px; }
h1{
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:700;
  font-size:64px;
  line-height:60.8px;
  margin:0 0 32px;
  text-transform:lowercase;
}
.toolbar{
  display:flex; gap:19.2px; flex-wrap:wrap; align-items:center;
  margin:32px 0 24px; justify-content:space-between;
}
.search{flex:1;min-width:300px;max-width:400px}
input[type="search"]{
  width:100%; padding:9.6px 12.8px; border:1px solid var(--border);
  border-radius:10px; background:var(--card); color:var(--text); outline:none;
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:400; font-size:12.8px; line-height:1;
}
.kpis{ display:flex; gap:12.8px; flex-wrap:wrap; min-width:fit-content; }
.kpis .chip{
  padding:9.6px 12.8px; border:1px solid var(--border); border-radius:999px;
  background:var(--card); color:var(--text);
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:500; font-size:12.8px; line-height:14.64px; text-transform:uppercase;
}
.kpis .chip small{ color:var(--muted); font-weight:400; margin-left:8px; text-transform:none; }
.filters{ display:flex; gap:9.6px; flex-wrap:wrap; min-width:fit-content; }
button.filter{
  padding:9.6px 12.8px; border:1px solid var(--border); background:var(--card);
  color:var(--text); border-radius:10px; cursor:pointer;
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:500; font-size:12.8px; line-height:14.64px; text-transform:uppercase;
}
button.filter.active{ background:var(--accent); color:#FFFFFF; border-color:var(--accent); }

.rwd-table{ width:100%; border-collapse:collapse; font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
.rwd-table th, .rwd-table td{ padding:10px 12px; border-bottom:1px solid #e7e7e7; vertical-align:top; }
.rwd-table th{ text-align:left; font-weight:600; background:#fafafa; }
.rwd-table tbody tr:hover{ background:#fcfcfc; }

@media (min-width: 801px){
  .num { text-align:right; font-variant-numeric: tabular-nums; }
}

@media (max-width: 800px) {
  .rwd-table thead { display: none; }
  .rwd-table tr {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;
    gap: 10px;
    padding: 12px 8px;
    border-bottom: 1px solid #E0E0E0;
  }
  .rwd-table td { padding: 0; border: none; }
  .rwd-table td::before { content: ""; display: none; }
  .rwd-table td { display: none; }
  .rwd-table td:nth-child(1),
  .rwd-table td:nth-child(6),
  .rwd-table td:nth-child(7) { display: block; }
  .rwd-table td:nth-child(1) { grid-column: 1; }
  .rwd-table td:nth-child(6),
  .rwd-table td:nth-child(7) { grid-column: 2; text-align: right; }
  .rwd-table td:nth-child(6) { font-size: 16px; font-weight: 500; }
  .rwd-table td:nth-child(7) { font-size: 13px; color: #666666; margin-top: -25px; }
  .rwd-table tr[data-status="open"] td:nth-child(6) { 
    grid-column: 2; 
    text-align: right; 
    font-size: 16px; 
    font-weight: 500; 
  }
  .rwd-table tr[data-status="open"] td:nth-child(6)::before {
    content: "Открыта";
    font-weight: 500;
    color: #A67900;
  }
  .rwd-table tr[data-status="open"] td:nth-child(6) > * {
    display: none;
  }
  .rwd-table tr[data-comment*="дивиден"] td:nth-child(6),
  .rwd-table tr[data-comment*="купон"] td:nth-child(6),
  .rwd-table tr[data-comment*="дивиден"] td:nth-child(7),
  .rwd-table tr[data-comment*="купон"] td:nth-child(7) { 
    display: block; 
    grid-column: 2; 
    text-align: right; 
  }
  .rwd-table tr[data-comment*="дивиден"] td:nth-child(6),
  .rwd-table tr[data-comment*="купон"] td:nth-child(6) { 
    font-size: 16px; 
    font-weight: 500; 
    margin-bottom: 0px;
  }
  .rwd-table tr[data-comment*="дивиден"] td:nth-child(7),
  .rwd-table tr[data-comment*="купон"] td:nth-child(7) { 
    font-size: 13px; 
    color: #666666; 
    margin-top: -5px;
  }
}
/* Cell/style */
.cell-num{
  text-align:center; font-variant-numeric:tabular-nums;
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:400; font-size:12.8px; line-height:1;
}
tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.04); }
tbody tr:nth-child(odd)  { background-color: rgba(0,0,0,0.01); }
tbody tr:hover{ background:#F0F0F0; }
th.sortable{ cursor:pointer; }

.badge{
  padding:6.4px 9.6px; border-radius:10px;
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:500; font-size:12.8px; line-height:14.64px; text-transform:uppercase;
  display:inline-block;
}
.badge-up{ background:rgba(25,179,107,.15); color:#008A44; border:1px solid rgba(25,179,107,.35); }
.badge-down{ background:rgba(255,77,79,.15); color:#ff8082; border:1px solid rgba(255,77,79,.35); }
.badge-pause{ background:rgba(245,165,36,.15); color:#A67900; border:1px solid rgba(245,165,36,.35); }
.badge-div{ background:rgba(78,161,255,.15); color:#528dcc; border:1px solid rgba(78,161,255,.35); }
.badge-neutral{ background:#F0F0F0; color:#666666; border:1px solid #E0E0E0; }

.status{
  padding:6.4px 9.6px; border-radius:10px;
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:500; font-size:12.8px;
  line-height:14px;
  text-transform:uppercase;
  display:inline-block;
}
.status.open{
  background:rgba(255,199,0,.12); color:#A67900; border:1px solid rgba(255,199,0,.25);
}
.status.closed{
  background:rgba(120,10,207,.12); color:#5D1D91; border:1px solid rgba(120,10,207,.25);
}
.status.info{
  background:#F0F0F0; color:#666666; border:1px solid #E0E0E0;
}

.cell-date{ white-space:nowrap; font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif; font-weight:400; font-size:12.8px; line-height:1; }
.negative{ color:#EF3124; font-weight:700; }
.positive{ color:#008A44; font-weight:700; }

tfoot td{
  padding:12.8px 16px; color:var(--muted);
  font-family:"San Francisco Pro", -apple-system, BlinkMacSystemFont, sans-serif;
  font-weight:400; font-size:12.8px; line-height:1;
}
.small{ color:var(--muted); font-weight:400; font-size:12.8px; line-height:1; }
.footer{ margin-top:24px; color:var(--muted); text-align:center; font-weight:400; font-size:16px; line-height:1; }
.suggestion-active {
    background-color: #f5f5f5 !important;
    font-weight: 500;
}
</style>
</head>
<body>
<div class="container">
  <h1 style="font-family: Arial, sans-serif; font-weight: 700; font-size: 80px; line-height: 76px; text-transform: lowercase; margin: 0 0 32px;">Сделки «Идеи от Гуру»</h1>

  <div class="toolbar">
    <div class="search" style="position: relative;">
      <input id="searchBox" type="search" placeholder="Поиск по эмитенту..." style="padding: 10px 16px; width: 100%;">
      <div id="searchSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #E0E0E0; border-top: none; border-radius: 0 0 10px 10px; max-height: 200px; overflow-y: auto; display: none; z-index: 1000;"></div>
    </div>
    <div class="kpis">
      <div class="chip">Всего: <span id="kpi-total">0</span><small></small></div>
      <div class="chip">Открытые: <span id="kpi-open">0</span></div>
      <div class="chip">Закрытые: <span id="kpi-closed">0</span></div>
    </div>
    <div class="filters">
      <button class="filter active" data-filter="all">ВСЕ</button>
      <button class="filter" data-filter="open">ОТКРЫТЫЕ</button>
      <button class="filter" data-filter="closed">ЗАКРЫТЫЕ</button>
      <button class="filter" data-filter="comment:рост">РОСТ</button>
      <button class="filter" data-filter="comment:падение">ПАДЕНИЕ</button>
      <button class="filter" data-filter="comment:тайм-аут">ТАЙМ-АУТ</button>
      <button class="filter" data-filter="comment:див">ВЫПЛАТЫ</button>
    </div>
  </div>

  <div class="table-wrap">
    <table id="signals" class="rwd-table">
      <thead>
        <tr>
          <th>Эмитент</th>
          <th>Дата открытия</th>
          <th>Комментарий</th>
          <th>Цена открытия</th>
          <th>Цена закрытия</th>
          <th>Результат</th>
          <th>Срок</th>
          <th>Статус</th>
        </tr>
      </thead>
      <tbody>
        <!-- Data will be loaded here by JavaScript -->
      </tbody>
      <tfoot><tr><td colspan="8" class="small"></td></tr></tfoot>
    </table>
  </div>
  <div class="footer small"></div>
</div>

<!-- Library for converting CSV to JSON. I've embedded it here to avoid an extra file. -->
<script>
(function() {
  /**
   *
   * Browser:
   * CSVJSON.csv2json(csv, options)
   *
   * Converts CSV to JSON. Returns an object. Use JSON.stringify to convert to a string.
   * Copyright (c) 2014-2019 Martin Drapeau
   *
   */
  var errorDetectingSeparator = "We could not detect the separator.",
      errorEmpty = "Empty CSV. Please provide something.",
      errorEmptyHeader = "Could not detect header. Ensure first row contains your column headers.",
      separators = [",", ";", "\t"],
      pegjsSeparatorNames = {
        ",": "comma",
        ";": "semicolon",
        "\t": "tab"
      };

  function detectSeparator(csv) {
    var counts = {},
        sepMax;
    separators.forEach(function(sep, i) {
      var re = new RegExp(sep, 'g');
      counts[sep] = (csv.match(re) || []).length;
      sepMax = !sepMax || counts[sep] > counts[sepMax] ? sep : sepMax;
    });
    return sepMax;
  }

  function zip() {
    var args = [].slice.call(arguments);
    var longest = args.reduce(function(a,b) {
      return a.length>b.length ? a : b;
    }, []);

    return longest.map(function(_,i) {
      return args.map(function(array) {
        return array[i];
      });
    });
  }

  function uniquify(keys) {
    var counts = {};
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      if (counts[key] === undefined) {
        counts[key] = 0;
      } else {
        counts[key]++;
      }
    }

    var result = [];
    for (var i = keys.length-1; i >= 0; i--) {
      var key = keys[i];
      if (counts[key] > 0) key = key + '__' + counts[key]--;
      result.unshift(key);
    }

    return result;
  }

  function convert(csv, options) {
    options || (options = {});
    if (csv.length == 0) throw errorEmpty;

    var separator = options.separator || detectSeparator(csv);
    if (!separator) throw errorDetectingSeparator;

    var a = [];
    try {
      var a = csvParser.parse(csv, pegjsSeparatorNames[separator]);
    } catch(error) {
      var start = csv.lastIndexOf('\n', error.offset),
          end = csv.indexOf('\n', error.offset),
          line = csv.substring(start >= -1 ? start : 0, end > -1 ? end : csv.length);
      throw error.message + ' On line ' + error.line + ' and column ' + error.column + '.\n' + line;
    }

    if (options.transpose) a = zip.apply(this, a);

    var keys = a.shift();
    if (keys.length == 0) throw errorEmptyHeader;
    keys = keys.map(function(key) {
      return key.trim().replace(/(^")|("$)/g, '');
    });

    keys = uniquify(keys);

    var	json = options.hash ? {} : [];
    for (var l = 0; l < a.length; l++) {
      var row = {},
      hashKey;
      for (var i = 0; i < keys.length; i++) {
        var value = (a[l][i]||'').trim().replace(/(^")|("$)/g, '');
        var number = value === "" ? NaN : value - 0;
        if (options.hash && i == 0) {
          hashKey = value;
        }
        else {
          if (options.parseJSON || options.parseNumbers && !isNaN(number)) {
            try {
              row[keys[i]] = JSON.parse(value);
            } catch(error) {
              row[keys[i]] = value;
            }
          }
          else {
            row[keys[i]] = value;
          }
        }
      }
      if (options.hash)
        json[hashKey] = row;
      else
        json.push(row);
    }
    return json;
  };

  var csvParser = (function(){
    function quote(s) {
       return '"' + s
        .replace(/\\/g, '\\\\')
        .replace(/"/g, '\\"')
        .replace(/\x08/g, '\\b')
        .replace(/\t/g, '\\t')
        .replace(/\n/g, '\\n')
        .replace(/\f/g, '\\f')
        .replace(/\r/g, '\\r')
        .replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g, escape)
        + '"';
    }
    var result = {
      parse: function(input, startRule) {
        var parseFunctions = {
          "comma": parse_comma,
          "semicolon": parse_semicolon,
          "tab": parse_tab
        };
        if (startRule === undefined) startRule = "comma";
        var pos = 0;
        var rightmostFailuresPos = 0;
        var rightmostFailuresExpected = [];
        function matchFailed(failure) {
          if (pos < rightmostFailuresPos) return;
          if (pos > rightmostFailuresPos) {
            rightmostFailuresPos = pos;
            rightmostFailuresExpected = [];
          }
          rightmostFailuresExpected.push(failure);
        }
        function parse_comma() {
          var result0;
          var pos0 = pos;
          result0 = (function() { separator = ','; return true; })() ? "" : null;
          if (result0 !== null) {
            result0 = parse_sv();
          }
          return result0;
        }
        function parse_semicolon() {
          var result0;
          result0 = (function() { separator = ';'; return true; })() ? "" : null;
          if (result0 !== null) {
            result0 = parse_sv();
          }
          return result0;
        }
        function parse_tab() {
          var result0;
          result0 = (function() { separator = '\t'; return true; })() ? "" : null;
          if (result0 !== null) {
            result0 = parse_sv();
          }
          return result0;
        }
        function parse_sv() {
          var result0, result1, result2, result3;
          var pos0 = pos;
          result0 = parse_line();
          if (result0 !== null) {
            result1 = [];
            var pos1 = pos;
            if (/^[\n\r]/.test(input.charAt(pos))) {
              result2 = input.charAt(pos);
              pos++;
            } else {
              result2 = null;
              matchFailed("[\\n\\r]");
            }
            if (result2 !== null) {
              result3 = parse_line();
              if (result3 !== null) {
                result2 = [result2, result3];
              } else {
                result2 = null;
                pos = pos1;
              }
            } else {
              result2 = null;
              pos = pos1;
            }
            while (result2 !== null) {
              result1.push(result2[1]);
              var pos1 = pos;
              if (/^[\n\r]/.test(input.charAt(pos))) {
                result2 = input.charAt(pos);
                pos++;
              } else {
                result2 = null;
                matchFailed("[\\n\\r]");
              }
              if (result2 !== null) {
                result3 = parse_line();
                if (result3 !== null) {
                  result2 = [result2, result3];
                } else {
                  result2 = null;
                  pos = pos1;
                }
              } else {
                result2 = null;
                pos = pos1;
              }
            }
            if (result1 !== null) {
              result0 = [result0, result1];
            } else {
              result0 = null;
              pos = pos0;
            }
          } else {
            result0 = null;
            pos = pos0;
          }
          if (result0 !== null) {
            result0[1].unshift(result0[0]);
            result0 = result0[1];
          }
          return result0;
        }
        function parse_line() {
          var result0, result1, result2, result3;
          var pos0 = pos;
          result0 = parse_field();
          if (result0 !== null) {
            result1 = [];
            var pos1 = pos;
            if (input.length > pos && input.charAt(pos) === separator) {
              result2 = separator;
              pos++;
            } else {
              result2 = null;
              matchFailed("separator");
            }
            if (result2 !== null) {
              result3 = parse_field();
              if (result3 !== null) {
                result2 = [result2, result3];
              } else {
                result2 = null;
                pos = pos1;
              }
            } else {
              result2 = null;
              pos = pos1;
            }
            while (result2 !== null) {
              result1.push(result2[1]);
              var pos1 = pos;
              if (input.length > pos && input.charAt(pos) === separator) {
                result2 = separator;
                pos++;
              } else {
                result2 = null;
                matchFailed("separator");
              }
              if (result2 !== null) {
                result3 = parse_field();
                if (result3 !== null) {
                  result2 = [result2, result3];
                } else {
                  result2 = null;
                  pos = pos1;
                }
              } else {
                result2 = null;
                pos = pos1;
              }
            }
            if (result1 !== null) {
              result0 = [result0, result1];
            } else {
              result0 = null;
              pos = pos0;
            }
          } else {
            result0 = null;
            pos = pos0;
          }
          if (result0 !== null) {
            result0[1].unshift(result0[0]);
            result0 = result0[1];
          }
          return result0;
        }
        function parse_field() {
          var result0, result1, result2;
          var pos0 = pos;
          if (input.charCodeAt(pos) === 34) {
            result0 = "\"";
            pos++;
          } else {
            result0 = null;
            matchFailed("\"\\\"\"");
          }
          if (result0 !== null) {
            result1 = [];
            result2 = parse_char();
            while (result2 !== null) {
              result1.push(result2);
              result2 = parse_char();
            }
            if (input.charCodeAt(pos) === 34) {
              result2 = "\"";
              pos++;
            } else {
              result2 = null;
              matchFailed("\"\\\"\"");
            }
            if (result2 !== null) {
              result0 = [result0, result1, result2];
              result0 = result1.join('');
            } else {
              result0 = null;
              pos = pos0;
            }
          }
          if (result0 === null) {
            result0 = [];
            var pos1 = pos;
            if (input.length > pos && /^[^,\n\r"]/.test(input.charAt(pos))) {
              result1 = input.charAt(pos);
              pos++;
            } else {
              result1 = null;
              matchFailed("[^,\\n\\r\"]");
            }
            while (result1 !== null) {
              result0.push(result1);
              if (input.length > pos && /^[^,\n\r"]/.test(input.charAt(pos))) {
                result1 = input.charAt(pos);
                pos++;
              } else {
                result1 = null;
                matchFailed("[^,\\n\\r\"]");
              }
            }
            result0 = result0.join('');
          }
          return result0;
        }
        function parse_char() {
          var result0, result1;
          if (input.substr(pos, 2) === "\"\"") {
            result0 = "\"\"";
            pos += 2;
            result0 = '"';
          } else {
            if (/^[^"]/.test(input.charAt(pos))) {
              result0 = input.charAt(pos);
              pos++;
            } else {
              result0 = null;
              matchFailed("[^\"]");
            }
          }
          return result0;
        }
        var separator = ',';
        var result = parseFunctions[startRule]();
        if (result === null || pos !== input.length) {
          var errorPosition = { line: 1, column: 1 };
          for (var i = 0; i < pos; i++) {
            if (input.charAt(i) === '\n') {
              errorPosition.line++;
              errorPosition.column = 1;
            } else {
              errorPosition.column++;
            }
          }
          var error = new Error("Syntax error at line " + errorPosition.line + ", column " + errorPosition.column);
          error.line = errorPosition.line;
          error.column = errorPosition.column;
          error.offset = pos;
          throw error;
        }
        return result;
      }
    };
    return result;
  })();

  if (typeof exports !== 'undefined') {
      if (typeof module !== 'undefined' && module.exports) {
          exports = module.exports = convert;
      }
      exports.csv2json = convert;
  } else {
    this.CSVJSON || (this.CSVJSON = {});
    this.CSVJSON.csv2json = convert;
  }
}).call(this);
</script>


<!-- Main application script -->
<script>
  // This is a dictionary of logos, you can add more.
  const logos = {
    'SBER': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/SBER.png', 'T': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/T.png', 'YDEX': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/YDEX.png', 'NVTK': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/NVTK.png', 'X5': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/X5.png', 'SIBN': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/SIBN.png', 'PLZL': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/PLZL.png', 'WUSH': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/WUSH.png', 'AFLT': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/AFLT.png', 'AFKS': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/AFKS.png', 'ALRS': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/ALRS.png', 'BSPB': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/BSPB.png', 'GAZP': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/GAZP.png', 'GMKN': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/GMKN.png', 'IRAO': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/IRAO.png', 'ROSN': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/ROSN.png', 'VKCO': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/VKCO.png', 'HEAD': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/HEAD.png', 'MTSS': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/MTSS.png', 'NLMK': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/NLMK.png', 'RUAL': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/RUAL.png', 'PHOR': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/PHOR.png', 'PIKK': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/PIKK.png', 'MTLR': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/MTLR.png', 'SNGS': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/SNGS.png', 'SVCB': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/SVCB.png', 'TATN': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/TATN.png', 'TRNFP': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/TRNFP.png', 'MAGN': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/MAGN.png', 'HYDR': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/HYDR.png', 'CHMF': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/CHMF.png', 'VSEH': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/VSEH.png', 'DIAS': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/DIAS.png', 'SMLT': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/SMLT.png', 'ASTR': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/ASTR.png', 'POSI': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/POSI.png', 'UGLD': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/UGLD.png', 'TRMK': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/TRMK.png', 'FLOT': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/FLOT.png', 'MGNT': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/MGNT.png', 'RTKM': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/RTKM.png', 'ETLN': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/ETLN.png', 'MOEX': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/MOEX.png', 'KMAZ': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/KMAZ.png', 'OZON': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/OZON.png', 'BELU': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/BELU.png', 'BANEP': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/BANEP.png', 'LKOH': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/LKOH.png', 'MBNK': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/MBNK.png', 'VTBR': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/VTBR.png', 'CNYRUB': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/CNYRUB.png', 'OFZ': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/RU000A10AA93.png', 'Т': 'https://mybroker.storage.bcs.ru/FinInstrumentLogo/T.png'
  };

document.addEventListener('DOMContentLoaded', function() {
  if ('ontouchstart' in window) {
    document.documentElement.classList.add('touch-device');
    document.querySelectorAll('.table-wrap').forEach(el => { el.style.webkitOverflowScrolling = 'touch'; });
  }

  // This is an Immediately Invoked Function Expression (IIFE) that runs asynchronously.
  (async function main() {
    let data = [];
    const tbody = document.querySelector('#signals tbody');

    try {
        // Fetch the CSV file. The `?v=` part is for cache-busting to ensure we always get the latest version.
        const response = await fetch('./deals.csv?v=' + Date.now(), { cache: 'no-store' });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();

        if (csvText.trim() === "") {
            console.warn('deals.csv is empty. No data to display.');
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Файл deals.csv пуст. Нет данных для отображения.</td></tr>';
        } else {
             // Convert CSV text to a JavaScript array of objects.
            data = CSVJSON.csv2json(csvText, { parseNumbers: true });
        }
    } catch (e) {
        console.error('Не удалось загрузить или обработать deals.csv:', e);
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px; color: red;"><b>Ошибка:</b> Не удалось загрузить данные из <b>deals.csv</b>. <br><br> Убедитесь, что файл находится в той же папке, что и этот HTML-файл, и вы открыли страницу через локальный веб-сервер.</td></tr>';
        return; // Stop the script if data loading fails
    }
    
    // If after all attempts data is still empty, do nothing more.
    if (data.length === 0) {
        return;
    }
    
    // --- FROM HERE, IT'S YOUR ORIGINAL CODE TO RENDER THE TABLE ---
    
    function badgeClass(t){
      const s=(t||'').toLowerCase();
      if(s==='рост') return 'badge-up';
      if(s==='падение') return 'badge-down';
      if(s==='тайм-аут') return 'badge-pause';
      if(s.includes('дивиден')) return 'badge-div';
      if(s.includes('купон')) return 'badge-div';
      return 'badge-neutral';
    }
    function statusOf(row){
      const dz=(row['Дата закрытия']||'').toString().trim().toLowerCase();
      const srok=(row['Срок']||'').toString().trim().toLowerCase();
      if(dz==='открыта' || srok==='в работе') return 'Открыта';
      return 'Закрыта';
    }
    function numSortVal(v){
      const s=(v??'').toString().trim().replace(/\s+/g,'').replace('%','').replace(',','.');
      const n=parseFloat(s);
      return isNaN(n)?'':n;
    }
    function dateSortVal(v){
      const s=(v??'').toString().trim();
      if(!s || s.toLowerCase()==='открыта') return '9999-12-31';
      const m=s.match(/(\d{2})\.(\d{2})\.(\d{4})/);
      return m? `${m[3]}-${m[2]}-${m[1]}` : s;
    }

    tbody.innerHTML = ''; // Clear any previous content or error messages

    data.forEach(row=>{
      const status = statusOf(row);
      const statusClass = status==='Открыта' ? 'open' : (status==='Закрыта' ? 'closed':'info');
      const tr = document.createElement('tr');
      tr.dataset.status = statusClass;
      tr.dataset.comment = (row['Комментарий']||'').toString().toLowerCase();

      const res=(row['Результат']||'').toString().trim();
      const resHtml = res ? (res.startsWith('-')
        ? `<span class="negative">${res}</span>`
        : `<span class="positive">${res}</span>`) : '';

      const ticker = (row['Тикер'] || '').toString().trim();
      const logoUrl = logos[ticker];
      const logoHtml = logoUrl
        ? `<div style="display: flex; align-items: center; gap: 12px;">
            <img src="${logoUrl}" alt="${ticker}" style="width: 36px; height: 36px; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'">
            <div style="display: flex; flex-direction: column; align-items: flex-start;">
              <span class="bold-emitent">${row['Эмитент'] || ''}</span>
              <span class="small" style="font-size: 14px;">${ticker}</span>
            </div>
          </div>`
        : (row['Эмитент'] || '');
      const commentRaw = (row['Комментарий'] ?? '').toString();
      const lc = commentRaw.toLowerCase();
      const isDivOrCoupon = lc.includes('дивиден') || lc.includes('купон');

      let resultCellHtml;
      let termCellHtml;

      if (isDivOrCoupon) {
        resultCellHtml = `<span class="desktop-only">—</span><span class="only-mobile">${row['Цена закрытия'] ?? ''}</span>`;
        termCellHtml = `<span class="desktop-only">—</span><span class="only-mobile">${row['Комментарий'] || ''}</span>`;
      } else {
        resultCellHtml = (status === 'Открыта' ? '—' : resHtml);
        termCellHtml = row['Срок'] || '';
      }

      tr.innerHTML = `
        <td class="bold-emitent" data-label="Эмитент">${logoHtml}</td>
        <td class="cell-date" data-sort="${dateSortVal(row['Дата открытия'])}" data-label="Дата открытия">${row['Дата открытия']||''}</td>
        <td data-label="Комментарий"><span class="badge ${badgeClass(row['Комментарий'])}">${row['Комментарий']||''}</span></td>
        <td class="cell-num num" data-sort="${numSortVal(row['Цена открытия'])}" data-label="Цена открытия">${row['Цена открытия']??''}</td>
        <td class="cell-num num" data-sort="${numSortVal(row['Цена закрытия'])}" data-label="Цена закрытия">${row['Цена закрытия']??''}</td>
        <td class="cell-num" data-sort="${numSortVal(row['Результат'])}" data-label="Результат">${resultCellHtml}</td>
        <td style="white-space: nowrap" data-label="Срок">${termCellHtml}</td>
        <td data-label="Статус"><span class="status ${statusClass}">${status}</span></td>
      `;
      tbody.appendChild(tr);
    });
    
    const rows = tbody.querySelectorAll('tr');
    document.getElementById('kpi-total').textContent  = rows.length;
    document.getElementById('kpi-open').textContent   = [...rows].filter(r=>r.dataset.status==='open').length;
    document.getElementById('kpi-closed').textContent = [...rows].filter(r=>r.dataset.status==='closed').length;

    const searchBox = document.getElementById('searchBox');
    const suggestionsContainer = document.getElementById('searchSuggestions');
    const emitents = [...new Set(data.map(row => row['Эмитент'] || '').filter(Boolean))];
    let currentSuggestionIndex = -1;
    let filteredSuggestions = [];

    searchBox.addEventListener('input', function() {
      const q = this.value.trim().toLowerCase();
      currentSuggestionIndex = -1;
      
      if (q.length > 0) {
        filteredSuggestions = emitents.filter(emitent => 
          emitent.toLowerCase().startsWith(q)
        );
        
        if (filteredSuggestions.length > 0) {
          suggestionsContainer.innerHTML = filteredSuggestions.map((emitent, index) => 
            `<div class="suggestion-item ${index === currentSuggestionIndex ? 'suggestion-active' : ''}" 
                 data-index="${index}" 
                 style="padding: 10px 16px; cursor: pointer; border-bottom: 1px solid #f0f0f0;" 
                 onmouseover="highlightSuggestion(${index})" 
                 onmouseout="resetSuggestionHighlight()"
                 onclick="selectSuggestion(${index})">
              ${emitent}
            </div>`
          ).join('');
          suggestionsContainer.style.display = 'block';
        } else {
          suggestionsContainer.style.display = 'none';
        }
      } else {
        suggestionsContainer.style.display = 'none';
        filteredSuggestions = [];
      }
      
      applyFilters(); // Apply filter as user types
    });

    searchBox.addEventListener('keydown', function(e) {
      if (suggestionsContainer.style.display === 'block') {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          currentSuggestionIndex = Math.min(currentSuggestionIndex + 1, filteredSuggestions.length - 1);
          highlightSuggestion(currentSuggestionIndex);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          currentSuggestionIndex = Math.max(currentSuggestionIndex - 1, -1);
          highlightSuggestion(currentSuggestionIndex);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (currentSuggestionIndex >= 0) {
            selectSuggestion(currentSuggestionIndex);
          } else {
            // If no suggestion is selected, just apply the current text as filter
            hideSuggestions();
            applyFilters();
          }
        } else if (e.key === 'Escape') {
          hideSuggestions();
        }
      }
    });

    document.addEventListener('click', function(e) {
      if (!searchBox.contains(e.target) && !suggestionsContainer.contains(e.target)) {
        hideSuggestions();
      }
    });
    
    // Make these functions globally accessible from inline HTML attributes
    window.highlightSuggestion = (index) => {
      const items = suggestionsContainer.querySelectorAll('.suggestion-item');
      items.forEach(item => item.classList.remove('suggestion-active'));
      
      if (index >= 0 && index < items.length) {
        items[index].classList.add('suggestion-active');
        currentSuggestionIndex = index;
      }
    }

    window.resetSuggestionHighlight = () => {
      const items = suggestionsContainer.querySelectorAll('.suggestion-item');
      items.forEach((item, idx) => {
        item.classList.toggle('suggestion-active', idx === currentSuggestionIndex);
      });
    }

    window.selectSuggestion = (index) => {
      if (index >= 0 && index < filteredSuggestions.length) {
        const selectedEmitent = filteredSuggestions[index];
        searchBox.value = selectedEmitent;
        
        setTimeout(() => {
          searchBox.focus();
          searchBox.setSelectionRange(selectedEmitent.length, selectedEmitent.length);
        }, 0);
        
        hideSuggestions();
        applyFilters(); // Apply filter on selection
      }
    }

    const hideSuggestions = () => {
      suggestionsContainer.style.display = 'none';
      currentSuggestionIndex = -1;
    }
    
    const buttons=document.querySelectorAll('button.filter');
    let activeFilter='all';
    
    buttons.forEach(btn=>{
      btn.addEventListener('click',()=>{
        buttons.forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        activeFilter=btn.dataset.filter;
        applyFilters();
      });
    });
    
    function applyFilters() {
      const rows = tbody.querySelectorAll('tr');
      const searchQuery = searchBox.value.trim().toLowerCase();

      rows.forEach(tr => {
        const status = tr.dataset.status;
        const comment = tr.dataset.comment || '';
        const emitentCell = tr.querySelector('td[data-label="Эмитент"]');
        const emitentText = emitentCell ? emitentCell.textContent.toLowerCase() : '';

        let show = true;
        
        // Filter by buttons
        if (activeFilter !== 'all') {
          if (activeFilter === 'open' && status !== 'open') show = false;
          else if (activeFilter === 'closed' && status !== 'closed') show = false;
          else if (activeFilter.startsWith('comment:')) {
            const key = activeFilter.split(':')[1];
            if (key === 'див') {
              if (!comment.includes('дивиден') && !comment.includes('купон')) show = false;
            } else if (!comment.includes(key)) show = false;
          }
        }
        
        // Filter by search query
        if (show && searchQuery) {
          if (!emitentText.includes(searchQuery)) show = false;
        }
        
        tr.style.display = show ? '' : 'none';
      });
    }

  })(); // Execute the main async function
});
</script>

</body>
</html>
